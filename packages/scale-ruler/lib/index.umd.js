(function(t,C){typeof exports=="object"&&typeof module<"u"?module.exports=C(require("vue")):typeof define=="function"&&define.amd?define(["vue"],C):(t=typeof globalThis<"u"?globalThis:t||self,t.ScaleRuler=C(t.Vue))})(this,function(t){"use strict";const C=t.defineComponent({__name:"CanvasPanel",props:{containerInfo:{type:Object,required:!0},opt:{type:Object,required:!0},canvasInfo:{type:Object,required:!0}},setup(l){const n=l,e=t.computed(()=>{var c,a;return{position:"absolute",left:0,top:0,width:((c=n.opt)==null?void 0:c.canvasWidth)+"px",height:((a=n.opt)==null?void 0:a.canvasHeight)+"px",transition:"transform 300ms",transformOrigin:"0 0",transform:`translate(${n.canvasInfo.translateX}px, ${n.canvasInfo.translateY}px) scale(${n.canvasInfo.scale})`,...n.opt.canvasStyle}});return(c,a)=>(t.openBlock(),t.createElementBlock("div",{ref:"canvasPanel",style:t.normalizeStyle(e.value)},null,4))}}),j=t.defineComponent({__name:"ScrollBar",props:{containerInfo:{type:Object,required:!0},opt:{type:Object,required:!0},isY:{type:Boolean,default:!1},scrollBarInfo:{type:Object,required:!0},scrollBarOpacity:{type:Object,required:!0},transformInfo:{type:Object,required:!0}},setup(l){const n=l,{scrollBarOpacity:e,transformInfo:c}=t.toRefs(n),a=t.computed(()=>{const{opt:r,scrollBarInfo:o,isY:f}=n,{scrollBarConfig:d}=r,g={position:"absolute",borderRadius:"4px",backgroundColor:d.bgColor,opacity:n.scrollBarOpacity[f?"yOpacity":"xOpacity"]||0,transition:"opacity 300ms",cursor:"pointer",zIndex:d.zIndex,width:(f?d.barSize:o.width)+"px",height:(f?o.height:d.barSize)+"px"};return f?(g.top=o.top+"px",g.right=0):(g.left=o.left+"px",g.bottom=0),g}),p=t.ref(null),i={};function s(r){if(r.preventDefault(),!e.value.isMouseDown)return;let{translateX:o,translateY:f}=c.value;const d=n.scrollBarInfo,{width:g,height:u}=n.containerInfo;if(n.isY){const y=r.pageY-i.startY;let O=i.top+y;O=Math.min(Math.max(0,O),u-d.height);const M=O*d.totalHeight/u;f=n.opt.containerYPadding-M,c.value.translateY=f}else{const y=r.pageX-i.startX;let O=i.left+y;O=Math.min(Math.max(0,O),g-d.width);const M=O*d.totalWidth/g;o=n.opt.containerXPadding-M,c.value.translateX=o}}return t.onMounted(()=>{if(p.value){const r=p.value,o=n.isY?"yOpacity":"xOpacity";r.addEventListener("mouseenter",()=>{e.value[o]=n.opt.scrollBarConfig.opacity,e.value[n.isY?"xOpacity":"yOpacity"]=0,e.value.isMouseEnter=!0}),r.addEventListener("mouseleave",()=>{e.value.isMouseEnter=!1,e.value[o]=0}),r.addEventListener("mousedown",f=>{e.value.isMouseDown=!0,i.startX=f.pageX,i.startY=f.pageY,i.left=n.scrollBarInfo.left,i.top=n.scrollBarInfo.top,document.addEventListener("mousemove",s)}),document.addEventListener("mouseup",()=>{e.value.isMouseDown=!1,document.removeEventListener("mousemove",s)})}}),(r,o)=>(t.openBlock(),t.createElementBlock("div",{ref_key:"scrollBarRef",ref:p,style:t.normalizeStyle(a.value)},null,4))}}),A=l=>l<=.25?40:l<=.5?20:l<=1?10:l<=2?5:l<=4?2:1,k=l=>{const n=l.getBoundingClientRect(),e=n.top+(document.body.scrollTop||document.documentElement.scrollTop),c=n.left+(document.body.scrollLeft||document.documentElement.scrollLeft);return{top:e,left:c}},H=(l,n,e,c)=>{t.nextTick(()=>{const a=c.value;if(a){const p=a.offsetWidth,i=a.offsetHeight,{rulerConfig:s}=l,{bgColor:r,fontFamily:o,fontSize:f,lineColor:d,fontColor:g}=s;if(p>0&&i>0){const u=a.getContext("2d");u.clearRect(0,0,p,i),r&&(u.save(),u.fillStyle=r,u.fillRect(0,0,p,i),u.restore());const y=e?s.yRulerWidth:s.xRulerHeight,{translateX:O,translateY:M,scale:h}=n,m=e?M:O,b=A(h),v=b*h,x=window.devicePixelRatio,L=-m,P=Math.floor(L/v),W=Math.floor(((e?i:p)-m)/v);u.save(),u.fillStyle=d,u.font=`${f*x}px ${o}`,u.translate(.5,.5),u.scale(1/x,1/x),e?u.fillRect((y-1)*x,0,1,i*x):u.fillRect(0,(y-1)*x,p*x,1);for(let S=P;S<=W;S++){u.fillStyle=d;const B=(m+S*v)*x;let w=y/4;S%10===0?w=y*4/5:S%5===0&&(w=y/3),e?u.fillRect((y-w)*x,B,w*x,1):(u.fillRect(B,(y-w)*x,1,w*x),S%10===0&&(u.fillStyle=g,u.fillText(String(S*b),B+2*x,(y+8-w)*x)))}if(u.restore(),e){u.font=`${f}px ${o}`;let S=P;for(;S<=W;)if(S%10)S++;else{u.save();const B=m+S*v+y/2;u.translate(B+y/5,B-y*6/5),u.rotate(Math.PI/2),u.fillText(String(S*b),y*4/5,B),S+=10,u.restore()}}}}})},q=(l,n)=>{const e=t.reactive([0]);function c(o,f=!0){const d=e.indexOf(o);f&&d===-1&&e.push(o),!f&&d>-1&&e.splice(d,1)}function a(o,f=!0){Array.isArray(o)?o.forEach(d=>c(d,f)):c(o,f)}function p(o){a(o),e.sort((f,d)=>f-d)}function i(o){a(o,!1)}const s=t.computed(()=>l.positionLineConfig[n?"adsorptionYList":"adsorptionXList"]);t.watch(()=>s.value,o=>{p(o)},{deep:!0});const r=t.computed(()=>n?l.canvasHeight:l.canvasWidth);return t.watch(()=>r.value,(o,f)=>{i(f),p(o)}),{adsorptionList:e}},E=(l,n,e)=>{const{scale:c,translateX:a,translateY:p}=n;return(l-(e?p:a))/c},$=(l,n,e)=>{const{scale:c,translateX:a,translateY:p}=n,i=l*c;return(e?p:a)+i};function D(l,n,e,c,a,p){const i={coordinate:a,translate:c},s=l.length;if(s>0){let r=0;for(;r<s;){const o=l[r];if(Math.abs(a-o)<=e){i.coordinate=o,i.translate=$(o,n,p);break}else if(o>a)break;r++}}return i}const F=(l,n,e,c,a)=>{let p=1;const i=t.reactive({});let s={},r=!1;function o(f){if(r&&s.id){const d=c?f.pageY:f.pageX-s.start,g=s.translate+d,u=E(g,e,c),y=D(n,e,l.positionLineConfig.adsorptionGap,g,u,c);Object.assign(s,y),i[s.id]=s}}return t.onMounted(()=>{if(a.value){const f=a.value;f.addEventListener("mousedown",d=>{const g=k(f),u=c?d.pageY:d.pageX,y=u-(c?g.top:g.left),O={translate:y,start:u,id:p,coordinate:E(y,e,c)};s=O,i[p++]=O,r=!0,document.addEventListener("mousemove",o)}),document.addEventListener("mouseup",d=>{document.removeEventListener("mousemove",o),r&&(r=!1,s={})})}}),{positionLineMap:i}},N=t.defineComponent({__name:"PositionLine",props:{containerInfo:{type:Object,required:!0},opt:{type:Object,required:!0},isY:{type:Boolean,default:!1},transformInfo:{type:Object,required:!0},lineInfo:{type:Object,required:!0}},setup(l){const n=l,e=t.computed(()=>n.opt.positionLineConfig.padding),c=t.computed(()=>2*e.value+1),a=t.computed(()=>{const{width:p,height:i}=n.containerInfo,{isY:s,lineInfo:r}=n;console.log(r,n,"-lineInfo-");const{translate:o}=r,f=s?`translate(0, ${o}px)`:`translate(${o}px, 0)`;return{width:(s?p:c.value)+"px",height:(s?c.value:i)+"px",cursor:s?"row-resize":"col-resize",top:(s?0:-e.value)+"px",left:(s?-e.value:0)+"px",transform:f}});return(p,i)=>(t.openBlock(),t.createElementBlock("div",{class:"scale-ruler_position-line",style:t.normalizeStyle(a.value)},i[0]||(i[0]=[t.createElementVNode("div",{class:"scale-ruler_position-line_inner"},null,-1),t.createElementVNode("div",{class:"scale-ruler_position-line_tip"},null,-1)]),4))}}),V=["width","height"],Y=t.defineComponent({__name:"Ruler",props:{containerInfo:{type:Object,required:!0},opt:{type:Object,required:!0},canvasInfo:{type:Object,required:!0},isY:{type:Boolean,default:!1},transformInfo:{type:Object,required:!0}},setup(l){const n=l,e=t.computed(()=>{const{isY:s,containerInfo:r,opt:o}=n;return{width:s?o.rulerConfig.yRulerWidth:r.width,height:s?r.height:o.rulerConfig.xRulerHeight}}),c=t.computed(()=>({position:"absolute",left:0,top:0,zIndex:n.opt.rulerConfig.zIndex+(n.isY?0:1)})),a=t.ref();t.watch([()=>n.containerInfo,()=>n.canvasInfo],()=>{H(n.opt,n.canvasInfo,n.isY,a)},{deep:!0});const{adsorptionList:p}=q(n.opt,n.isY),{positionLineMap:i}=F(n.opt,p,n.transformInfo,n.isY,a);return console.log(i),(s,r)=>(t.openBlock(),t.createElementBlock(t.Fragment,null,[t.createElementVNode("canvas",{ref_key:"rulerRef",ref:a,style:t.normalizeStyle(c.value),width:e.value.width,height:e.value.height},null,12,V),t.createElementVNode("div",null,[(t.openBlock(!0),t.createElementBlock(t.Fragment,null,t.renderList(Object.keys(t.unref(i)),o=>(t.openBlock(),t.createBlock(N,{key:o,opt:n.opt,"is-y":!n.isY,"transform-info":n.transformInfo,"container-info":n.containerInfo,"line-info":t.unref(i)[o]},null,8,["opt","is-y","transform-info","container-info","line-info"]))),128))])],64))}});function K(l){return l&&l.__esModule&&Object.prototype.hasOwnProperty.call(l,"default")?l.default:l}var _,X;function U(){if(X)return _;X=1;var l=function(m){return n(m)&&!e(m)};function n(h){return!!h&&typeof h=="object"}function e(h){var m=Object.prototype.toString.call(h);return m==="[object RegExp]"||m==="[object Date]"||p(h)}var c=typeof Symbol=="function"&&Symbol.for,a=c?Symbol.for("react.element"):60103;function p(h){return h.$$typeof===a}function i(h){return Array.isArray(h)?[]:{}}function s(h,m){return m.clone!==!1&&m.isMergeableObject(h)?O(i(h),h,m):h}function r(h,m,b){return h.concat(m).map(function(v){return s(v,b)})}function o(h,m){if(!m.customMerge)return O;var b=m.customMerge(h);return typeof b=="function"?b:O}function f(h){return Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(h).filter(function(m){return Object.propertyIsEnumerable.call(h,m)}):[]}function d(h){return Object.keys(h).concat(f(h))}function g(h,m){try{return m in h}catch{return!1}}function u(h,m){return g(h,m)&&!(Object.hasOwnProperty.call(h,m)&&Object.propertyIsEnumerable.call(h,m))}function y(h,m,b){var v={};return b.isMergeableObject(h)&&d(h).forEach(function(x){v[x]=s(h[x],b)}),d(m).forEach(function(x){u(h,x)||(g(h,x)&&b.isMergeableObject(m[x])?v[x]=o(x,b)(h[x],m[x],b):v[x]=s(m[x],b))}),v}function O(h,m,b){b=b||{},b.arrayMerge=b.arrayMerge||r,b.isMergeableObject=b.isMergeableObject||l,b.cloneUnlessOtherwiseSpecified=s;var v=Array.isArray(m),x=Array.isArray(h),L=v===x;return L?v?b.arrayMerge(h,m,b):y(h,m,b):s(m,b)}O.all=function(m,b){if(!Array.isArray(m))throw new Error("first argument should be an array");return m.reduce(function(v,x){return O(v,x,b)},{})};var M=O;return _=M,_}var G=U();const T=K(G),I={scale:1,canScale:!0,maxScale:10,minScale:.1,autoCenter:!0,autoScale:!0,containerAutoSize:!1,containerWidth:1e3,containerHeight:500,containerXPadding:80,containerYPadding:80,canvasWidth:1920,canvasHeight:2e3,proxyScaleKey:!0,useScrollBar:!0,useRuler:!0,usePositionLine:!0,positionLineConfig:{lineColor:"#24aa61",padding:3,adsorptionXList:[],adsorptionYList:[],adsorptionGap:4,zIndex:300},canvasStyle:{},scrollBarConfig:{bgColor:"#000000",opacity:.4,zIndex:500,barSize:8},rulerConfig:{yRulerWidth:30,xRulerHeight:30,bgColor:"#efefef",fontColor:"#000000",fontSize:12,fontFamily:"Arial",lineColor:"#000000",zIndex:400},onScale:()=>{},onMove:()=>{}},J=function(){const l={};for(const n in I){const e=I[n];typeof e=="object"&&e!==null?l[n]=()=>e:l[n]=e}return l}(),Q=(l,n)=>{const e=t.reactive({width:0,height:0,originWidth:0,originHeight:0});function c(s,r){new ResizeObserver(f=>{for(const d of f)if(d.target===r){const g=r.offsetWidth,u=r.offsetHeight;(g!==e.originWidth||u!==e.originHeight)&&a(s,r)}}).observe(r)}function a(s,r,o=!1){const f=s.value;f.containerAutoSize?(e.width=r.offsetWidth,e.height=r.offsetHeight,e.originWidth=e.width,e.originHeight=e.height,o&&c(s,r)):(e.width=f.containerWidth,e.height=f.containerHeight);const d=getComputedStyle(r);d.boxSizing==="border-box"&&(e.width-=parseFloat(d.borderLeftWidth)+parseFloat(d.borderRightWidth),e.height-=parseFloat(d.borderTopWidth)+parseFloat(d.borderBottomWidth)),d.position==="static"&&(e.position="relative")}t.onMounted(()=>{const s=n.value;s&&a(l,s,!0)});const p=t.computed(()=>({width:e.width,height:e.height})),i=t.computed(()=>{const s=l.value,r={overflow:"hidden"};return s.containerAutoSize||(r.width=e.width+"px",r.height=e.height+"px"),e.position&&(r.position=e.position),r});return{containerInfo:p,containerStyle:i}},Z=(l,n)=>{const e=t.reactive({});return t.watch(()=>n.value,()=>{const c=l.value;let a=0,p=0,{scale:i}=c;const{autoCenter:s,autoScale:r}=c,{width:o,height:f}=n.value;if(r){const u=(o-2*c.containerXPadding)/c.canvasWidth,y=(f-2*c.containerYPadding)/c.canvasHeight;i=Math.min(u,y)}e.scale=i;let d=0,g=0;a=c.canvasWidth*i,p=c.canvasHeight*i,s&&(d=Math.floor((o-a)/2),g=Math.floor((f-p)/2),e.translateX=d,e.translateY=g)},{deep:!0}),{transformInfo:e}},ee=(l,n,e)=>({scrollBarInfo:t.computed(()=>{const a=l.value,{width:p,height:i}=n.value,{translateX:s,translateY:r,scale:o}=e,f=a.canvasWidth*o+2*a.containerXPadding,d=a.canvasHeight*o+2*a.containerYPadding,g=p<f,u=i<d,y=g||u,O=p*((a.containerXPadding-s)/f),M=i*((a.containerYPadding-r)/f),h=p/f*p,m=i/d*i;return{totalHeight:d,totalWidth:f,left:O,top:M,width:h,height:m,isYLarge:u,isXLarge:g,isLarge:y}})});function R(l,n,e){const c=l.value,{containerXPadding:a,containerYPadding:p,canvasWidth:i,canvasHeight:s}=c,r=i*e,o=s*e,{width:f,height:d}=n.value,g=Math.max((f-r)/2,a),u=Math.max((d-o)/2,p),y=r+2*a>f?f-(r+a):g,O=o+2*p>d?d-(o+p):u;return{maxTranslateX:g,maxTranslateY:u,minTranslateX:y,minTranslateY:O}}const te=(l,n,e)=>({boundaryInfo:t.computed(()=>R(l,n,e.scale))}),z=(l,n,e,c)=>{const a=l.value;let{translateX:p,translateY:i,scale:s}=e;c=Math.min(Math.max(c,a.minScale),a.maxScale);const r=c-s,o=R(l,n,c);p-=r*a.canvasWidth/2,i-=r*a.canvasHeight/2,p=Math.max(Math.min(p,o.maxTranslateX),o.minTranslateX),i=Math.max(Math.min(i,o.maxTranslateY),o.minTranslateY),e.scale=c,e.translateX=p,e.translateY=i},ne=(l,n,e)=>{l.value.proxyScaleKey&&document.addEventListener("keydown",c=>{if(l.value.canScale){const a=c.keyCode;if((c.metaKey||c.ctrlKey)&&(a===187||a===189)){c.preventDefault();const p=e.scale+(a===187?.05:-.05);z(l,n,e,p)}}})},oe=(l,n,e,c,a,p)=>{let i=null;const s=t.reactive({xOpacity:0,yOpacity:0,isMouseDown:!1,isMouseEnter:!1});return t.onMounted(()=>{a.value&&a.value.addEventListener("wheel",r=>{if(r.metaKey||r.ctrlKey){r.preventDefault();const o=-1*r.deltaY/100,f=e.scale+o;z(l,n,e,f)}else{if(!p.value.isLarge||s.isMouseDown)return;r.preventDefault();let{translateX:o,translateY:f}=e;i&&clearTimeout(i);const d=-r.deltaX,g=-r.deltaY;let u="";const{opacity:y=.4}=l.value.scrollBarConfig,{isXLarge:O,isYLarge:M}=p.value,{maxTranslateX:h,minTranslateX:m,maxTranslateY:b,minTranslateY:v}=c.value;O&&Math.abs(d)>Math.abs(g)&&(o+=d,o=Math.max(Math.min(o,h),m),s.xOpacity=y,s.yOpacity=0,e.translateX=o,u="x"),M&&Math.abs(g)>Math.abs(d)&&(u="y",f+=g,f=Math.max(Math.min(f,b),v),s.yOpacity=y,s.xOpacity=0,e.translateY=f),u&&(i=setTimeout(()=>{s.isMouseEnter||(s[u==="y"?"yOpacity":"xOpacity"]=0)},1e3))}})}),{scrollBarOpacity:s}};return t.defineComponent({__name:"ScaleRuler",props:t.mergeDefaults({scale:{},minScale:{},maxScale:{},canScale:{type:Boolean},autoCenter:{type:Boolean},autoScale:{type:Boolean},containerAutoSize:{type:Boolean},containerWidth:{},containerHeight:{},containerXPadding:{},containerYPadding:{},canvasWidth:{},canvasHeight:{},proxyScaleKey:{type:Boolean},useScrollBar:{type:Boolean},useRuler:{type:Boolean},usePositionLine:{type:Boolean},positionLineConfig:{},canvasStyle:{},scrollBarConfig:{},rulerConfig:{},onScale:{type:Function},onMove:{type:Function}},J),setup(l){const n=l,e=t.ref(T(I,n)),c=t.ref(null),{containerInfo:a,containerStyle:p}=Q(e,c),{transformInfo:i}=Z(e,a),{boundaryInfo:s}=te(e,a,i),r=t.computed(()=>Object.assign({},i,s.value)),{scrollBarInfo:o}=ee(e,a,i),f=t.reactive({}),d=t.watch(()=>r.value,u=>{if(u.scale){const y={scale:u.scale,translateX:u.translateX,translateY:u.translateY};f.scale||Object.assign(f,y),d()}});t.watch(()=>n,()=>{e.value=T(e.value,n)},{deep:!0}),ne(e,a,i);const{scrollBarOpacity:g}=oe(e,a,i,s,c,o);return console.log(g,"--scrollBarOpacity-"),(u,y)=>(t.openBlock(),t.createElementBlock("div",{ref_key:"container",ref:c,style:t.normalizeStyle(t.unref(p))},[e.value.useRuler?(t.openBlock(),t.createElementBlock(t.Fragment,{key:0},[t.createVNode(Y,{opt:e.value,"container-info":t.unref(a),"canvas-info":r.value,"transform-info":t.unref(i)},null,8,["opt","container-info","canvas-info","transform-info"]),t.createVNode(Y,{"is-y":"",opt:e.value,"container-info":t.unref(a),"canvas-info":r.value,"transform-info":t.unref(i)},null,8,["opt","container-info","canvas-info","transform-info"])],64)):t.createCommentVNode("",!0),t.createVNode(C,{"container-info":t.unref(a),opt:e.value,"canvas-info":r.value,"transform-info":t.unref(i)},{default:t.withCtx(()=>[t.renderSlot(u.$slots,"default")]),_:3},8,["container-info","opt","canvas-info","transform-info"]),t.unref(o).isXLarge?(t.openBlock(),t.createBlock(j,{key:1,opt:e.value,"container-info":t.unref(a),"scroll-bar-info":t.unref(o),"scroll-bar-opacity":t.unref(g),"transform-info":t.unref(i)},null,8,["opt","container-info","scroll-bar-info","scroll-bar-opacity","transform-info"])):t.createCommentVNode("",!0),t.unref(o).isYLarge?(t.openBlock(),t.createBlock(j,{key:2,opt:e.value,"container-info":t.unref(a),"scroll-bar-info":t.unref(o),"scroll-bar-opacity":t.unref(g),"transform-info":t.unref(i),"is-y":""},null,8,["opt","container-info","scroll-bar-info","scroll-bar-opacity","transform-info"])):t.createCommentVNode("",!0)],4))}})});
